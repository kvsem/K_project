{% load static %}
{% include 'base/base.html' %}
<style>
    .post_context {
        max-height:60%;
        overflow: hidden;
        -webkit-mask-image: -webkit-gradient(linear, left top, left bottom, from(rgba(0,0,0,1)), to(rgba(0,0,0,0)));
    }
</style>
<body>
    <!-- Wrapper -->
        <div id="wrapper">
            <!-- Header -->
            {% include 'base/header.html' %}
            <!-- Menu -->
            {% include 'base/menu.html' %}
            <!-- Main -->
                <div id="main">
                    {% for content in contents_list %}
                    <!-- Post -->
                        <article class="post">
                            <header>
                                <div class="title">
                                    <h2><a href="/view/?id={{ content.id }}">{{ content.title }}</a></h2>
                                    <p>{{ content.category }}</p>
                                </div>
                                <div class="meta">

                                    <time class="published" datetime="2015-11-01">{{ content.write_date }}</time>
                                    <a href="/accounts/profile/?user_id={{ content.user_id }}" class="author"><span class="name">{{ content.nickname }}</span><img src='{{ content.profile_image }}' alt="" width="40px" height="40px"/></a>
                                </div>
                            </header>
                            <!-- <a href="/view/?id={{ content.id }}" class="image featured"><img src={% static 'images/pic01.jpg' %} alt="" /></a> -->
                            <div class="post_context">
				<p>{{ content.context|safe|linebreaksbr }}</p>
			    </div>
                            <footer>
                                <ul class="actions">
                                    <li><a href="/view/?id={{ content.id }}" class="button big">Continue Reading</a></li>
                                </ul>
                                <ul class="stats">
                                    {% if content.user_id == user_info.user_id %}<li><a href="/modify/?id={{ content.id }}">MODIFY</a></li>{% endif %}
                                    <li><div class="icon fa-heart" data-post="{{ content.id }}">{{ content.like }}</div></li>
                                    <li><div class="icon fa-comment">{{ content.comment_list | length }}</div></li>
                                </ul>
                            </footer>

                            <div class="comment_info">
                                <ul class="comments">
                                    {% for comment in content.comment_list %}
                                    <li class="comment">
                                        <div class="comment_profile">
                                            <img class="comment_profile_image" src="{{ comment.profile_image }}" width="100%" height="100%"/>
                                            <div class="comment_profile_nickname">{{ comment.nickname }}</div>
                                            <div class="comment_created_at">{{ comment.created_at }}</div>
                                        </div>
                                        <div class="comment_text">
                                            {{ comment.comment }}
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>

                                {% if user.is_authenticated %}
                                <form method="post" action="/write_comment/">
                                    {% csrf_token %}
                                    <div class="write_comment">
                                        <input type="hidden" name="post_id" value="{{ content.id }}">
                                        COMMENT
                                        <input type="text" name="comment_text">
                                    </div>
                                </form>
                                {% endif %}
                            </div>
                        </article>
                    {% endfor %}

                    <!-- Pagination -->
                        <ul class="actions pagination">
                            <li><a href="/post/?page={{pages.prev_page}}" class={% if pages.page == 0 %}"disabled button big previous"{% else %}"button big next"{% endif %}>Previous Page</a></li>
                            <li><a href="/post/?page={{pages.next_page}}" class={% if pages.max_page == pages.page %}"disabled button big previous"{% else %}"button big next"{% endif %}>Next Page</a></li>
                        </ul>

                </div>
        {% include 'base/side.html' %}
        </div>
</body>

<script>
    var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    });

    jQuery(".fa-heart").on('click', function () {
        jQuery(this).css('color', 'red');
        var origin_like = jQuery(this).text();
        var increased_like = (origin_like * 1) + 1;
        jQuery(this).text(increased_like);

        // 디비 업데이트
        var post_data = {
            post_id : jQuery(this).data().post
        };

        var request = jQuery.ajax({
            type: "POST",
            url: "/increase_like/",
            data: JSON.stringify(post_data),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8'
        });

        request.done(function(result) {
        }).fail(function(err) {
            console.error(err.statusText);
        });
        jQuery(this).off('click');
    });

    jQuery(".comment_info").hide();
    jQuery(".fa-comment").on('click', function () {
        if (jQuery(this).parent().parent().parent().parent().find(".comment_info").css("display") === "none") {
            jQuery(this).parent().parent().parent().parent().find(".comment_info").show();
        }
        else {
            jQuery(this).parent().parent().parent().parent().find(".comment_info").hide();
        }
    });
</script>